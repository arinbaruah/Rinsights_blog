{
  "hash": "4bb1d273a2394a0a388e17e8cfd70016",
  "result": {
    "markdown": "---\ntitle: \"Detecting a possible event of bank churn using machine learning classification models üí∏üè¶\"\nauthor: \"Arindam Baruah\"\ndate: \"2024-01-18\"\ncategories: [analysis,exploratory data analysis,visualisation,statistics,machine learning,classification model]\nimage: \"figure/fig1.png\"\nnumber-sections: true\ntoc: true\nexecute: \n  echo: false\n  warning: false\n  message: false\n---\n\n![Source: Medium](figure/fig1.png)\n\n# What is a bank churn and why does it occur ? {#sec-intro}\n\nWith the advent of digital banking, it has become extremely convenient for users to open a new bank account. As opposed to the age old tradition of submitting multiple documents and credit histories after visiting a bank, the process has been revamped by a great deal with an user needing less than 10 minutes to open an account in the comfort of their couches.\n\nHowever, with digital banking, it has also become convenient for users to close a bank account, more commonly termed as a **\"churn\"**. While this may appear to be a win for consumers, it is however important to understand the reasons and the effects that entail from a bank churn.\n\n::: {.callout-note}\n# Reasons for a churn to occur\nA bank account churn could occur for a multitiude of reasons which are important for banks to analyse to reduce attrition of customers and also remain competitive in the market. Some of the reasons are:\n\n-   **Fees and Charges:** High fees or unexpected charges can prompt customers to switch banks. This may include monthly maintenance fees, ATM fees, overdraft fees, and other charges.\n-   **Low Interest Rates:** If a bank offers low interest rates on savings accounts or certificates of deposit, customers might look for better opportunities elsewhere to maximize their returns.\n-   **Poor Customer Service:** Inadequate customer service, long wait times, and unhelpful staff can lead to frustration and dissatisfaction, prompting customers to seek better service elsewhere.\n-   **Branch Accessibility:** Limited access to physical branches or ATMs can be a significant factor. If a customer moves to an area where their current bank has limited presence, they might switch to a more accessible option.\n-   **Technology and Online Services:** Customers may switch to a bank that provides better online and mobile banking services, as technology plays an increasingly crucial role in the banking experience.\n-   **Incentives and Promotions:** Banks often attract new customers by offering promotions, bonuses, or better interest rates. Existing customers may churn to take advantage of these offers.\n-   **Changes in Financial Needs:** As individuals' financial situations evolve, their banking needs may change. For example, a customer might require more advanced financial products, and if their current bank can't meet those needs, they may switch to a different institution.\n-   **Mergers and Acquisitions:** Changes resulting from bank mergers or acquisitions, such as alterations in account terms, fees, or service quality, can drive customers to seek alternatives.\n-   **Ethical or Social Reasons:** Some customers may choose to switch banks due to concerns about a bank's ethical practices, social responsibility, or involvement in controversial activities.\n-   **Security Concerns:** If a bank experiences a security breach or if customers perceive their accounts to be at risk, they may opt to move their funds to a more secure institution.\n-   **Better Financial Products:** Customers may switch banks to access better financial products, such as higher-interest savings accounts, more competitive loan rates, or improved credit card offerings.\n-   **Life Events:** Major life events like marriage, divorce, retirement, or the death of a spouse can prompt individuals to reassess their banking relationships and switch to better-suited options.\n:::\n\n\n\n# Importing the relevant libraries and dataset \n::: panel-tabset\n## Packages used\n\nIn order to initiate our analysis of the bank account data, we will read all the required libraries and then take a glimpse of how our data looks like.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(naniar)\nlibrary(bookdown)\nlibrary(stringr)\nlibrary(stringi)\nlibrary(lubridate)\nlibrary(DT)\nlibrary(forcats)\nlibrary(ggthemes)\nlibrary(corrplot)\nlibrary(mltools)\nlibrary(data.table)\nlibrary(visdat)\nlibrary(janitor)\nlibrary(cowplot)\nlibrary(caTools)\nlibrary(pscl)\nlibrary(ROCR)\nlibrary(caret)\nlibrary(xgboost)\nlibrary(randomForest)\nlibrary(lightgbm)\nlibrary(Matrix)\nlibrary(catboost)\nlibrary(kableExtra)\nlibrary(plotly)\nlibrary(ggExtra)\n```\n:::\n\n\n## Dataset glimpse\n\n\n::: {#tbl-data .cell tbl-cap='Bank churn dataset'}\n::: {.cell-output-display}\n`````{=html}\n<table class=\" lightable-paper\" style='font-size: 9px; font-family: \"Arial Narrow\", arial, helvetica, sans-serif; margin-left: auto; margin-right: auto;'>\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> id </th>\n   <th style=\"text-align:right;\"> CustomerId </th>\n   <th style=\"text-align:left;\"> Surname </th>\n   <th style=\"text-align:right;\"> CreditScore </th>\n   <th style=\"text-align:left;\"> Geography </th>\n   <th style=\"text-align:left;\"> Gender </th>\n   <th style=\"text-align:right;\"> Age </th>\n   <th style=\"text-align:right;\"> Tenure </th>\n   <th style=\"text-align:right;\"> Balance </th>\n   <th style=\"text-align:right;\"> NumOfProducts </th>\n   <th style=\"text-align:right;\"> HasCrCard </th>\n   <th style=\"text-align:right;\"> IsActiveMember </th>\n   <th style=\"text-align:right;\"> EstimatedSalary </th>\n   <th style=\"text-align:right;\"> Exited </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;width: 30em; background-color: yellow !important;\"> 15674932 </td>\n   <td style=\"text-align:left;\"> Okwudilichukwu </td>\n   <td style=\"text-align:right;\"> 668 </td>\n   <td style=\"text-align:left;\"> France </td>\n   <td style=\"text-align:left;\"> Male </td>\n   <td style=\"text-align:right;\"> 33 </td>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:right;\"> 0.0 </td>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 181449.97 </td>\n   <td style=\"text-align:right;font-weight: bold;border-right:1px solid;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;width: 30em; background-color: yellow !important;\"> 15749177 </td>\n   <td style=\"text-align:left;\"> Okwudiliolisa </td>\n   <td style=\"text-align:right;\"> 627 </td>\n   <td style=\"text-align:left;\"> France </td>\n   <td style=\"text-align:left;\"> Male </td>\n   <td style=\"text-align:right;\"> 33 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0.0 </td>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 49503.50 </td>\n   <td style=\"text-align:right;font-weight: bold;border-right:1px solid;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:right;width: 30em; background-color: yellow !important;\"> 15694510 </td>\n   <td style=\"text-align:left;\"> Hsueh </td>\n   <td style=\"text-align:right;\"> 678 </td>\n   <td style=\"text-align:left;\"> France </td>\n   <td style=\"text-align:left;\"> Male </td>\n   <td style=\"text-align:right;\"> 40 </td>\n   <td style=\"text-align:right;\"> 10 </td>\n   <td style=\"text-align:right;\"> 0.0 </td>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 184866.69 </td>\n   <td style=\"text-align:right;font-weight: bold;border-right:1px solid;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:right;width: 30em; background-color: yellow !important;\"> 15741417 </td>\n   <td style=\"text-align:left;\"> Kao </td>\n   <td style=\"text-align:right;\"> 581 </td>\n   <td style=\"text-align:left;\"> France </td>\n   <td style=\"text-align:left;\"> Male </td>\n   <td style=\"text-align:right;\"> 34 </td>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:right;\"> 148882.5 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 84560.88 </td>\n   <td style=\"text-align:right;font-weight: bold;border-right:1px solid;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 4 </td>\n   <td style=\"text-align:right;width: 30em; background-color: yellow !important;\"> 15766172 </td>\n   <td style=\"text-align:left;\"> Chiemenam </td>\n   <td style=\"text-align:right;\"> 716 </td>\n   <td style=\"text-align:left;\"> Spain </td>\n   <td style=\"text-align:left;\"> Male </td>\n   <td style=\"text-align:right;\"> 33 </td>\n   <td style=\"text-align:right;\"> 5 </td>\n   <td style=\"text-align:right;\"> 0.0 </td>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 15068.83 </td>\n   <td style=\"text-align:right;font-weight: bold;border-right:1px solid;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 5 </td>\n   <td style=\"text-align:right;width: 30em; background-color: yellow !important;\"> 15771669 </td>\n   <td style=\"text-align:left;\"> Genovese </td>\n   <td style=\"text-align:right;\"> 588 </td>\n   <td style=\"text-align:left;\"> Germany </td>\n   <td style=\"text-align:left;\"> Male </td>\n   <td style=\"text-align:right;\"> 36 </td>\n   <td style=\"text-align:right;\"> 4 </td>\n   <td style=\"text-align:right;\"> 131778.6 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 136024.31 </td>\n   <td style=\"text-align:right;font-weight: bold;border-right:1px solid;\"> 1 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n:::\n\n# Data description\n\nBased on a brief research, the description for each variable in the dataset is as follows:\n\n1. __CustomerId:__ Unique identifier for each customer\n2. __Surname:__ Name associated with the customer\n3. __CreditScore:__ Credit score of the customer\n4. __Geography:__ Location of the bank account based on geographical location of the bank\n5. __Gender:__ Gender of the customer\n6. __Age:__ Current age of the customer\n7. __Tenure:__ Length of time since the opening of the bank account\n8. __Balance:__ Current credit balance in the account\n9. __NumOfProducts:__ Number of banking services used by the customer\n10. __HasCrCard:__ An indicator for whether the customer has a credit card\n11. __IsActiveMember:__ Is the customer a regular user of the bank account through transactions\n12. __EstimatedSalary:__ Estimated earning declared as salary for the customer\n13. __Exited:__ Has the customer closed the bank account\n\n# Data cleaning\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Check for missing values in the dataset](index_files/figure-html/fig-misvis-1.png){#fig-misvis width=672}\n:::\n:::\n\nAs we can observe from @fig-misvis, the dataset is clean and __does not have any missing values to be dealt with.__ While this is ideal, it is however not the only check that we must perform in the data.\n\n# Data sanity checks\n::: panel-tabset\n\n## CustomerId\n\n\n\n::: {#tbl-occur .cell tbl-cap='Number of occurrences of each customer'}\n::: {.cell-output-display}\n`````{=html}\n<table>\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> CustomerId </th>\n   <th style=\"text-align:right;\"> Total_occurrences </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 15682355 </td>\n   <td style=\"text-align:right;\"> 121 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 15570194 </td>\n   <td style=\"text-align:right;\"> 99 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 15585835 </td>\n   <td style=\"text-align:right;\"> 98 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 15595588 </td>\n   <td style=\"text-align:right;\"> 91 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 15648067 </td>\n   <td style=\"text-align:right;\"> 90 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 15793331 </td>\n   <td style=\"text-align:right;\"> 90 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\nBased on @tbl-occur, we can observe that the same customer ID appears multiple number of times in the dataset when infact, it was supposed to appear just once. Hence, we can consider the CustomerId variable to be serving no purpose in the current dataset. This shall be dropped in the feature selection section.\n\n\n## Estimated Salary\n\nThe estimated salary variable indicates the income of each customer declared as a salary. __Salaries can never be negative.__ Let us quickly check if that indeed is the case.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Salary distribution of customers](index_files/figure-html/fig-salary-1.png){#fig-salary width=672}\n:::\n:::\n\nBased on the histrogram of the salaries as illustrated by @fig-salary, we can observe that the salaries are __indeed positive which is what is expected.__\n\n## Age\n\nBank account customers are generally required to be adults (> 18 years). We will check if that holds true for the current dataset and attempt to detect any anomalous data such as negative age.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Age distribution of the bank customers](index_files/figure-html/fig-age-1.png){#fig-age width=672}\n:::\n:::\n\nBased on @fig-age, we can observe that the data indeed suggests that the customers are of the right age (>18 years) and there are no anomalous data entries for this variable.\n\n\n:::\n\n# Exploratory Data Analysis\n\nBefore we create a prediction model, we need to understand how are our variables correlated to one another. This will be done through various visualisations as follows:\n\n\n## Correlation plot\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Correlation plot](index_files/figure-html/fig-corrplot-1.png){#fig-corrplot width=672}\n:::\n:::\n\n:::{.callout-note}\n# Key takeaway\nBased on our understanding of the variables as illustrated by the correlation plot in @fig-corrplot, we can infer that there is __no single variable which is highly correlated__ to the churn indicator. __We can also observe that none of the features are highly correlated to one another. This indicates that there is no multicollinearity in the choice of our features.__\n:::\n\n## Geography wise churn\n\nLet us try to understand if there are any geographical regions which have accounted for high churns.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Bank accounts for each geographical location](index_files/figure-html/fig-geo-1.png){#fig-geo width=672}\n:::\n:::\n\n\nBased on the illustration @fig-geo, we can observe that the percentage of churns are significantly higher in Germany as compared to France and Spain where the churn percentage appears to be similar.\n\n:::{.callout-note}\n# Key takeaway\n\nThe higher churn % for Germany could indicate issues pertaining to the economy of the country or factors such as loan interest rate in the country. It could also indicate that the banking services or customer services in Germany might be lacking as compared to the other countries which have resulted in the higher churn percentage. Diving deeper into the banking practices of Germany would provide a better understanding as to the reason for the high attrition of customers.\n:::\n\n## Age wise bank churn\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Age wise churn data](index_files/figure-html/fig-age-churn-1.png){#fig-age-churn width=672}\n:::\n:::\n\n\nAs we can observe through @fig-age-churn, the churns are associated majorly with customers between the ages of 25 and 60.\n\n:::{.callout-note}\n# Key takeaway\n\nThe data indicates that after a couple of years since opening a new bank account, customers are observed to close their accounts which could be due to numerous reasons such as:\n\n1. Better customer services from other banks \n2. Low credit score or due to financial bankruptcy of the customer\n3. High loan interests charged by the bank which may have led the customer to switch to another bank after fulfilling the loan.\n:::\n\n## Credit score wise churn\n\nLet us now try to analyse if the credit scores could tell us anything about the likelihood of the bank account churns.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Credit score distribution of churned accounts](index_files/figure-html/fig-cred-1.png){#fig-cred width=672}\n:::\n:::\n\n\n:::{.callout-note}\n# Key takeaway\n\nBased on the credit score distribution of the churned and active accounts as illustrated in @fig-cred, we __cannot observe any discernible difference in the credit scores which could indicate the likeliness of a bank account churn__. This indicates that the credit scores of customers may not be a strong factor leading to them closing their bank accounts.\n:::\n\n## Transaction activity wise churn \n\nNext, we can analyse if the churns are mostly from bank accounts which are inactive, possibly due to very low transactions.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Transaction activity wise churn](index_files/figure-html/fig-transact-1.png){#fig-transact width=672}\n:::\n:::\n\n\n:::{.callout-note}\n# Key takeaway\n\nBased on @fig-transact, we can observe that the percentage of the __bank churns for inactive accounts are more than twice that of the active accounts.__\n\nThis indicates that the probability of a churn rises if the transaction activity of the bank account reduces. This could also be measure taken by the bank to reduce the burden of keeping the services activated for accounts which have shown little to no activity for an extended period of duraiton.\n\n:::\n\n## Balance wise churn\n\nLet us try to analyse if the account balance can indicate whether a churn might take place. \n\nFor this, we will flag any balance which is 0.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Account balance wise churn](index_files/figure-html/fig-balance-1.png){#fig-balance width=672}\n:::\n:::\n\n:::{.callout-note}\n# Key takeaway\n\n@fig-balance illustrates the percentage of bank accounts churned for accounts with positive balance and zero balance. Contrary to belief, the percentage of churns are actually higher for accounts with positive balance as compared to zero balance accounts. \n\nThis could be due to the fact that account holders with zero balances are generally inactive and may not proactively close their accounts but rather, is done so by the bank to reduce the maintenance cost of keeping zero balance accounts active. However, account holders with positive balance may proactively choose to close their accounts due to various reasons as stated in @sec-intro which may lead to the higher percentage of churned accounts.\n:::\n\n\n# Model creation\n::: panel-tabset\nNow that we have analysed the variables, visualised them and cleaned the data into a machine readable form, we will now be working on a predictive model to be able to accurately predict whether the bank account details of a customer can help indicate if a bank account churn might occur.\n\nLet us create our train and test datasets as follows:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(101)\nsample =  sample.split(df_bank_num$Exited,SplitRatio = 0.7)\ntrain = subset(df_bank_num,sample == T)\ntest = subset(df_bank_num,sample == F)\n```\n:::\n\n\nHere, we have allocated 70% of the dataset as the training dataset which will be used to train our machine learning model while the remaining 30% of the dataset will be allocated as a test dataset which will allow us to understand the accuracy of our classification model.\n\n## Logistic Regression\n\nHere, we will fit the logistic regression model to the train data as follows.\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel_logit <- glm(Exited~.,family=binomial(link='logit'),data=train)\n```\n:::\n\n::: {.cell}\n\n:::\n\n\nLet us study the performance of the logistic regression model through the Receiver Operating Curve (ROC) metric.\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![ROC-AUC metric](index_files/figure-html/fig-roclog-1.png){#fig-roclog fig-align='center' width=672}\n:::\n:::\n\nBased on the receiver operating curve as illustrated by @fig-roclog, we can observe that while a sizeable are of the graph is covered by the curve, it can however by improved by possibly a better classification algorithm.\n\n\n::: {.cell}\n\n:::\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![Confusion matrix for Logistic Regression classification model](index_files/figure-html/fig-conflog-1.png){#fig-conflog fig-align='center' width=672}\n:::\n:::\n\n\n@fig-conflog depicts a more intuitive way to understand the performance of the Logistic Regression. The model was able to predict the churned accounts with an __accuracy of 83.4%__. \n\n## XGboost classifier\n\n\nLet us try to use an extra gradient boosted ensemble method commonly termed as the XGboost classifier.\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n```\n[1]\ttrain-logloss:0.430351 \n[2]\ttrain-logloss:0.381727 \n```\n:::\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![Confusion matrix for XGBoost classification model](index_files/figure-html/fig-confxgb-1.png){#fig-confxgb fig-align='center' width=672}\n:::\n:::\n\n\nWe observe a marginally __better classification accuracy as compared to the logistic regression model for the XGboosted classifier as depicted by @fig-confxgb with an accuracy of 85.1%.__\n\n\n\n## Light GBM\n\nLet us utilise the LGBM algorithm and train it on the given dataset.\n\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![Confusion matrix for Light GBM classification model](index_files/figure-html/fig-lgbconf-1.png){#fig-lgbconf fig-align='center' width=672}\n:::\n:::\n\nBased on @fig-lgbconf, we can observe that the LGB classifier has actually classified poorly with multiple negatives observed in its classification. We can disregard this model for our purpose of classification.\n\n## Catboost classifier\n\n\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![Importance of each variable based on the Catboost classification algorithm](index_files/figure-html/fig-catimp-1.png){#fig-catimp fig-align='center' width=672}\n:::\n:::\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![Confusion matrix for Catboost classification model](index_files/figure-html/fig-catconf-1.png){#fig-catconf fig-align='center' width=672}\n:::\n:::\n\n\nUpon utilising the Catboost classifier, we can observe from @fig-catconf that the classifier __has a marginally better accuracy when compared to the logistic regression, XGboost and Light GBM.__\n\nAdditionally, @fig-catimp indicates the variables which have the highest importance in predicting the bank account churns. We can observe that the variables, \"Number of products\" followed by \"Age\" and \"Activity\" are the most critical to be able to predict tge churned accounts. \n\n:::\n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../../../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}